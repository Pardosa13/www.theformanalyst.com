{% extends "base.html" %}

{% block title %}{{ meeting.meeting_name }} - Enter Results{% endblock %}

{% block content %}

<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESULTS ENTRY â€” dark premium theme
     ALL JS-referenced classes/IDs UNCHANGED
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* â”€â”€ Page header â”€â”€ */
  .entry-header {
    margin-bottom: 20px;
    padding-bottom: 18px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .entry-header h1 {
    font-size: 1.4rem;
    font-weight: 800;
    margin: 0;
    color: var(--text-primary);
  }
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--accent);
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    transition: color 0.15s, gap 0.15s;
  }
  .back-link:hover { color: #8ba4f5; gap: 10px; }

  /* â”€â”€ Auto-fetch banner â”€â”€ */
  .autofetch-banner {
    background: linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(5,150,105,0.10) 100%);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: 12px;
    padding: 18px 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 14px;
  }
  .autofetch-title {
    font-size: 15px;
    font-weight: 700;
    color: #34d399;
    margin-bottom: 5px;
  }
  .autofetch-desc {
    font-size: 13px;
    color: var(--text-muted);
  }
  .autofetch-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* Auto-fetch buttons â€” styled dark, forms/actions unchanged */
  .btn-autofetch {
    background: rgba(16,185,129,0.15) !important;
    color: #34d399 !important;
    border: 1px solid rgba(16,185,129,0.35) !important;
    font-weight: 700 !important;
    padding: 10px 18px !important;
    font-size: 14px !important;
    white-space: nowrap;
    transition: background 0.2s, box-shadow 0.2s !important;
  }
  .btn-autofetch:hover {
    background: rgba(16,185,129,0.25) !important;
    box-shadow: 0 4px 16px rgba(16,185,129,0.2) !important;
    transform: translateY(-1px) !important;
  }

  /* â”€â”€ Meeting meta card â”€â”€ */
  .meta-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 14px 18px;
    margin-bottom: 16px;
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
  }
  .meta-item { font-size: 13px; color: var(--text-muted); }
  .meta-item strong { color: var(--text-secondary); font-weight: 600; }

  /* â”€â”€ Race navigation â”€â”€ */
  .race-nav {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    padding: 14px 18px;
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  .race-nav-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-right: 6px;
  }
  .race-nav-btn {
    padding: 6px 14px;
    border-radius: 7px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 700;
    transition: opacity 0.15s, transform 0.15s;
    color: white;
  }
  .race-nav-btn:hover { opacity: 0.85; transform: translateY(-1px); color: white; }
  .race-nav-btn.pending  { background: linear-gradient(135deg, var(--accent), var(--accent-2)); }
  .race-nav-btn.complete { background: linear-gradient(135deg, #065f46, #10b981); }

  /* â”€â”€ Race card â”€â”€ */
  .race-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: 14px;
    margin-bottom: 20px;
    overflow: hidden;
    transition: border-color 0.2s;
    scroll-margin-top: 20px;
  }
  .race-card.complete { border-left: 3px solid #10b981; }

  .race-card-header {
    background: var(--bg-elevated);
    border-bottom: 1px solid var(--border-subtle);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
  }
  .race-card-header h2 {
    font-size: 1rem;
    font-weight: 700;
    margin: 0;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .race-complete-badge {
    font-size: 12px;
    font-weight: 600;
    color: #34d399;
    background: rgba(16,185,129,0.12);
    border: 1px solid rgba(16,185,129,0.25);
    padding: 2px 10px;
    border-radius: 20px;
  }
  .race-meta {
    display: flex;
    gap: 14px;
    font-size: 12px;
    color: var(--text-muted);
    flex-wrap: wrap;
  }
  .race-meta strong { color: var(--text-secondary); }

  .race-card-body { padding: 16px 20px; }

  /* â”€â”€ Entry table â”€â”€ */
  .entry-table { width: 100%; border-collapse: collapse; }

  .entry-table thead tr {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
  }
  .entry-table thead th {
    padding: 11px 14px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.9);
    text-align: center;
  }
  .entry-table thead th:nth-child(2) { text-align: left; }

  .entry-table tbody tr {
    border-bottom: 1px solid var(--border-subtle);
    transition: background 0.15s;
  }
  .entry-table tbody tr:last-child { border-bottom: none; }

  /* Base row colours â€” dark theme versions */
  .entry-table tbody tr.row-odd     { background: rgba(255,255,255,0.02); }
  .entry-table tbody tr.row-even    { background: transparent; }
  .entry-table tbody tr.row-done    { background: rgba(16,185,129,0.08); }

  .entry-table td {
    padding: 11px 14px;
    vertical-align: middle;
    font-size: 13px;
    color: var(--text-secondary);
    text-align: center;
  }
  .entry-table td:nth-child(2) { text-align: left; }

  .pos-cell {
    font-weight: 700;
    font-size: 15px;
    width: 44px;
  }

  .horse-name-cell {
    font-weight: 700;
    color: var(--text-primary);
    font-size: 13px;
  }
  .horse-jt {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    margin-top: 2px;
  }

  .score-cell {
    font-weight: 800;
    font-size: 16px;
    color: var(--text-primary);
    font-family: 'DM Mono', monospace;
  }

  .odds-cell {
    font-weight: 700;
    color: #34d399;
    font-family: 'DM Mono', monospace;
  }

  /* â”€â”€ Finish buttons â€” class names UNCHANGED â”€â”€ */
  .finish-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
    flex-wrap: wrap;
  }

  /* Base finish button â€” dark themed */
  .finish-btn {
    width: 42px;
    height: 36px;
    border: 1px solid var(--border-mid);
    border-radius: 6px;
    background: var(--bg-elevated);
    color: var(--text-secondary);
    font-weight: 700;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s, color 0.15s;
    font-size: 13px;
    line-height: 1;
    font-family: 'DM Mono', monospace;
  }

  .finish-btn:hover {
    border-color: var(--accent);
    background: rgba(102,126,234,0.12);
    color: var(--text-primary);
  }

  /* Selected states â€” ALL kept for JS compatibility */
  .finish-btn.selected {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
    color: white;
    border-color: var(--accent);
  }

  /* Position-specific selected colours â€” UNCHANGED from original */
  .finish-btn[data-position="1"].selected {
    background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
    border-color: #ffd700;
    color: #333;
  }
  .finish-btn[data-position="2"].selected {
    background: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%);
    border-color: #c0c0c0;
    color: #333;
  }
  .finish-btn[data-position="3"].selected {
    background: linear-gradient(135deg, #cd7f32 0%, #b87333 100%);
    border-color: #cd7f32;
    color: white;
  }
  .finish-btn[data-position="5"].selected {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border-color: #dc3545;
    color: white;
  }
  .finish-btn.scr-btn.selected {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    border-color: #6c757d;
    color: white;
  }

  /* â”€â”€ SP input â€” class names UNCHANGED â”€â”€ */
  .sp-input {
    width: 78px;
    padding: 7px 8px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-mid);
    border-radius: 6px;
    text-align: center;
    font-weight: 700;
    font-size: 13px;
    color: var(--text-primary);
    font-family: 'DM Mono', monospace;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .sp-input::placeholder { color: var(--text-muted); font-weight: 400; }
  .sp-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  /* .filled class toggled by JS */
  .sp-input.filled {
    border-color: #10b981;
    background: rgba(16,185,129,0.08);
    color: #34d399;
  }
  .sp-input:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  /* â”€â”€ Save button row â”€â”€ */
  .save-row {
    margin-top: 16px;
    display: flex;
    justify-content: flex-end;
  }

  /* â”€â”€ Back to top â”€â”€ */
  .back-top {
    display: block;
    text-align: center;
    margin: 28px 0 8px;
  }
  .back-top a {
    display: inline-block;
    padding: 9px 20px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-mid);
    color: var(--text-secondary);
    border-radius: 8px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    transition: border-color 0.2s, color 0.2s;
  }
  .back-top a:hover {
    border-color: var(--accent);
    color: var(--text-primary);
  }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 768px) {
    .entry-header { flex-direction: column; align-items: flex-start; }
    .autofetch-banner { flex-direction: column; }
    .race-card-body { padding: 12px; }
    .entry-table thead { display: none; }
    .entry-table tbody tr { display: block; padding: 12px; border-bottom: 1px solid var(--border-subtle); }
    .entry-table td { display: block; text-align: left !important; padding: 4px 0; border: none; }
    .finish-buttons { justify-content: flex-start; }
    .save-row { justify-content: stretch; }
    .save-row .btn { width: 100%; text-align: center; }
  }
</style>

<!-- Page header -->
<div class="entry-header">
  <h1>{{ meeting.meeting_name }}</h1>
  <a href="{{ url_for('results') }}" class="back-link">â† Back to Results</a>
</div>

<!-- Auto-fetch banner â€” forms/actions/onsubmit UNCHANGED -->
{% if meeting.puntingform_id %}
<div class="autofetch-banner">
  <div>
    <div class="autofetch-title">ğŸª„ Auto-Fetch Available</div>
    <div class="autofetch-desc">This meeting was imported from PuntingForm API. Click to automatically populate all results.</div>
  </div>
  <div class="autofetch-actions">
    <form action="{{ url_for('fetch_automatic_results', meeting_id=meeting.id) }}"
          method="POST"
          style="margin:0;"
          onsubmit="return confirm('Fetch all race results automatically from PuntingForm?');">
      <button type="submit" class="btn btn-autofetch">
        ğŸ”„ Auto-Fetch All Results
      </button>
    </form>
    <form action="{{ url_for('mark_scratched_and_complete', meeting_id=meeting.id) }}"
          method="POST"
          style="margin:0;"
          onsubmit="return confirm('Mark all remaining horses as scratched and complete this meeting?');">
      <button type="submit" class="btn btn-autofetch">
        âœ… Mark Scratched & Complete
      </button>
    </form>
  </div>
</div>
{% endif %}

<!-- Meeting meta -->
<div class="meta-card">
  <div class="meta-item"><strong>Analysed:</strong> {{ meeting.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</div>
  <div class="meta-item"><strong>Total Races:</strong> {{ results.races|length }}</div>
</div>

<!-- Race navigation â€” Jinja logic UNCHANGED -->
<div class="race-nav">
  <span class="race-nav-label">Jump to Race:</span>
  {% for race in results.races %}
    {% set race_complete = true %}
    {% for horse in race.horses %}
      {% if horse.result_finish is none %}{% set race_complete = false %}{% endif %}
    {% endfor %}
    <a href="#race-{{ race.race_number }}"
       class="race-nav-btn {% if race_complete %}complete{% else %}pending{% endif %}">
      R{{ race.race_number }}{% if race_complete %} âœ“{% endif %}
    </a>
  {% endfor %}
</div>

<!-- Race cards â€” all form actions, hidden fields, and Jinja logic UNCHANGED -->
{% for race in results.races %}
  {% set race_complete = true %}
  {% for horse in race.horses %}
    {% if horse.result_finish is none %}{% set race_complete = false %}{% endif %}
  {% endfor %}

  <div class="race-card {% if race_complete %}complete{% endif %}"
       id="race-{{ race.race_number }}">

    <div class="race-card-header">
      <h2>
        Race {{ race.race_number }}
        {% if race_complete %}<span class="race-complete-badge">âœ“ Complete</span>{% endif %}
      </h2>
      <div class="race-meta">
        {% if race.distance %}<span><strong>Distance:</strong> {{ race.distance }}</span>{% endif %}
        {% if race.race_class %}<span><strong>Class:</strong> {{ race.race_class }}</span>{% endif %}
        {% if race.track_condition %}<span><strong>Track:</strong> {{ race.track_condition|capitalize }}</span>{% endif %}
      </div>
    </div>

    <div class="race-card-body">
      <!-- form action, method, hidden race_number â€” ALL UNCHANGED -->
      <form method="POST" action="{{ url_for('save_results', meeting_id=meeting.id) }}">
        <input type="hidden" name="race_number" value="{{ race.race_number }}">

        <div style="overflow-x: auto;">
          <table class="entry-table">
            <thead>
              <tr>
                <th>Pos</th>
                <th style="text-align:left;">Horse</th>
                <th>Score</th>
                <th>Odds</th>
                <th>Finish</th>
                <th>SP</th>
              </tr>
            </thead>
            <tbody>
              {% for horse in race.horses %}
              <tr class="{% if horse.result_finish is not none %}row-done{% elif loop.index is odd %}row-odd{% else %}row-even{% endif %}">

                <td class="pos-cell">
                  {% if loop.index == 1 %}ğŸ¥‡
                  {% elif loop.index == 2 %}ğŸ¥ˆ
                  {% elif loop.index == 3 %}ğŸ¥‰
                  {% else %}{{ loop.index }}{% endif %}
                </td>

                <td>
                  <div class="horse-name-cell">{{ horse.horse_name }}</div>
                  <div class="horse-jt">
                    {% if horse.jockey %}J: {{ horse.jockey }}{% endif %}
                    {% if horse.trainer %} | T: {{ horse.trainer }}{% endif %}
                  </div>
                </td>

                <td class="score-cell">{{ "%.1f"|format(horse.score) }}</td>

                <td class="odds-cell">{{ horse.odds }}</td>

                <td>
                  <!-- finish-buttons container, class names, onclick, data-position â€” ALL UNCHANGED -->
                  <div class="finish-buttons" data-horse-id="{{ horse.horse_id }}">
                    {% for pos in [1, 2, 3, 4] %}
                    <button type="button"
                            class="finish-btn {% if horse.result_finish == pos %}selected{% endif %}"
                            data-position="{{ pos }}"
                            onclick="selectFinish(this, {{ horse.horse_id }}, {{ pos }})">
                      {{ pos }}
                    </button>
                    {% endfor %}
                    <button type="button"
                            class="finish-btn {% if horse.result_finish == 5 %}selected{% endif %}"
                            data-position="5"
                            onclick="selectFinish(this, {{ horse.horse_id }}, 5)">
                      UP
                    </button>
                    <button type="button"
                            class="finish-btn scr-btn {% if horse.result_finish == 0 %}selected{% endif %}"
                            data-position="0"
                            onclick="selectFinish(this, {{ horse.horse_id }}, 0)">
                      SCR
                    </button>
                    <!-- id="finish_{{ horse.horse_id }}" â€” UNCHANGED -->
                    <input type="hidden"
                           name="finish_{{ horse.horse_id }}"
                           id="finish_{{ horse.horse_id }}"
                           value="{{ horse.result_finish or '' }}">
                  </div>
                </td>

                <td>
                  <!-- name, id, class="sp-input" â€” ALL UNCHANGED -->
                  <input type="number"
                         name="sp_{{ horse.horse_id }}"
                         id="sp_{{ horse.horse_id }}"
                         value="{{ horse.result_sp or '' }}"
                         step="0.01"
                         min="1.01"
                         max="999"
                         placeholder="$0.00"
                         class="sp-input {% if horse.result_sp %}filled{% endif %}">
                </td>

              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="save-row">
          <button type="submit" class="btn btn-primary" style="padding: 11px 24px; font-size: 14px;">
            ğŸ’¾ Save Race {{ race.race_number }} Results
          </button>
        </div>

      </form>
    </div>
  </div>
{% endfor %}

<!-- Back to top -->
<div class="back-top">
  <a href="#">â†‘ Back to Top</a>
</div>

<!-- JS â€” 100% IDENTICAL TO ORIGINAL -->
<script>
function selectFinish(button, horseId, position) {
    // Remove selected class from siblings
    const container = button.parentElement;
    container.querySelectorAll('.finish-btn').forEach(btn => {
        btn.classList.remove('selected');
    });

    // Add selected class to clicked button
    button.classList.add('selected');

    // Update hidden input
    document.getElementById('finish_' + horseId).value = position;

    // Handle SP field for scratched horses
    const spInput = document.getElementById('sp_' + horseId);
    if (position === 0) {
        // Scratched horses don't have SP
        spInput.value = '';
        spInput.disabled = true;
        spInput.placeholder = 'N/A';
    } else {
        // Enable SP field for horses that ran
        spInput.disabled = false;
        spInput.placeholder = '$0.00';
    }

    // Update row background if both fields filled
    checkRowComplete(horseId);
}

function checkRowComplete(horseId) {
    const finish = document.getElementById('finish_' + horseId).value;
    const sp = document.getElementById('sp_' + horseId).value;
    const row = document.querySelector(`input[name="finish_${horseId}"]`).closest('tr');

    if (finish && sp) {
        row.style.backgroundColor = '#d4edda';
    }
}

// Add listeners to SP inputs
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sp-input').forEach(input => {
        input.addEventListener('input', function() {
            const horseId = this.name.replace('sp_', '');

            if (this.value) {
                this.classList.add('filled');
            } else {
                this.classList.remove('filled');
            }

            checkRowComplete(horseId);
        });

        // Check initial state
        if (input.value) {
            input.classList.add('filled');
        }
    });
});
</script>

{% endblock %}
