{% extends "base.html" %}

{% block title %}Import from PuntingForm API{% endblock %}

{% block content %}
<h1>üåê Import Meetings from PuntingForm</h1>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('dashboard') }}" style="color: #667eea; text-decoration: none;">‚Üê Back to Dashboard</a>
</div>

<!-- Date Selection Card -->
<div class="card" style="margin-bottom: 20px;">
    <h3 style="margin: 0 0 15px 0;">Select Meeting Date</h3>
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <input 
            type="date" 
            id="meeting-date" 
            style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;"
        >
        <button 
            onclick="loadMeetings()" 
            class="btn btn-primary"
            style="padding: 10px 30px; font-size: 16px;"
        >
            üìÖ Get Meetings
        </button>
    </div>
    <p style="color: #6c757d; margin: 15px 0 0 0; font-size: 14px;">
        üí° Select a date to view all available meetings for that day
    </p>
</div>

<!-- Meetings Display -->
<div class="card">
    <div id="loading" style="display: none; text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
        <p style="color: #6c757d; font-size: 18px;">Loading meetings from PuntingForm...</p>
    </div>
    
    <div id="meetings-container" style="display: none;">
        <div style="margin-bottom: 25px;">
            <h2 style="margin: 0 0 10px 0;">Available Meetings</h2>
            <p style="color: #6c757d; margin: 0;">Click any meeting to import and analyze</p>
        </div>
        
        <div id="meetings-list"></div>
    </div>
    
    <div id="error-container" style="display: none; text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
        <p style="color: #dc3545; font-size: 18px; margin-bottom: 10px;">Failed to load meetings</p>
        <p id="error-message" style="color: #6c757d;"></p>
        <button onclick="loadMeetings()" class="btn btn-primary" style="margin-top: 20px;">
            Retry
        </button>
    </div>
    
    <div id="initial-state" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 64px; margin-bottom: 20px;">üèá</div>
        <h3 style="color: #2d3748; margin-bottom: 10px;">Ready to Import Meetings</h3>
        <p style="color: #6c757d; font-size: 16px;">Select a date above and click "Get Meetings" to start</p>
    </div>
</div>

<style>
.meeting-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.meeting-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}

.meeting-card.importing {
    opacity: 0.6;
    pointer-events: none;
}

.meeting-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 12px;
}

.meeting-title {
    font-size: 20px;
    font-weight: 600;
    color: #2d3748;
}

.meeting-badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.meeting-details {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    color: #6c757d;
    font-size: 14px;
}

.meeting-details span {
    display: flex;
    align-items: center;
    gap: 5px;
}

.jurisdiction-header {
    font-size: 24px;
    font-weight: 700;
    margin: 30px 0 15px 0;
    color: #2d3748;
    padding-bottom: 10px;
    border-bottom: 3px solid #667eea;
}

.jurisdiction-header:first-child {
    margin-top: 0;
}
</style>

<script>
const JURISDICTION_COLORS = {
    'VIC': '#003f87',
    'NSW': '#00a8e1',
    'QLD': '#8b0000',
    'SA': '#e03c31',
    'WA': '#ffd700',
    'TAS': '#006747',
    'ACT': '#00539f',
    'NT': '#d4581e'
};

// Set default date to today on page load
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('meeting-date').value = today;
});

async function loadMeetings() {
    const dateInput = document.getElementById('meeting-date').value;
    
    if (!dateInput) {
        alert('Please select a date');
        return;
    }
    
    // Hide all containers
    document.getElementById('initial-state').style.display = 'none';
    document.getElementById('meetings-container').style.display = 'none';
    document.getElementById('error-container').style.display = 'none';
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    
    try {
        const response = await fetch(`/api/meetings/date/${dateInput}`);
        const data = await response.json();
        
        if (!data.success) {
            showError(data.error || 'Unknown error');
            return;
        }
        
        if (data.meetings.length === 0) {
            showError('No meetings available for this date');
            return;
        }
        
        displayMeetings(data.meetings);
        
    } catch (error) {
        console.error('Error loading meetings:', error);
        showError(error.message);
    }
}

function displayMeetings(meetings) {
    const grouped = {};
    
    // Group by state
    meetings.forEach(meeting => {
        const state = meeting.state || 'OTHER';
        if (!grouped[state]) {
            grouped[state] = [];
        }
        grouped[state].push(meeting);
    });
    
    let html = '';
    
    // Sort states
    const sortedStates = Object.keys(grouped).sort();
    
    sortedStates.forEach(state => {
        const color = JURISDICTION_COLORS[state] || '#6c757d';
        
        html += `<div class="jurisdiction-header" style="color: ${color};">${state}</div>`;
        
        grouped[state].forEach(meeting => {
            html += createMeetingCard(meeting);
        });
    });
    
    document.getElementById('meetings-list').innerHTML = html;
    document.getElementById('loading').style.display = 'none';
    document.getElementById('meetings-container').style.display = 'block';
}

function createMeetingCard(meeting) {
    return `
        <div class="meeting-card" data-meeting-id="${meeting.meeting_id}" data-date="${meeting.date}">
            <div class="meeting-header">
                <div class="meeting-title">${meeting.track_name}</div>
                <div class="meeting-badge" style="background: #6c757d; color: white;">
                    ${meeting.state}
                </div>
            </div>
            <div class="meeting-details">
                <span>üìÖ ${meeting.date}</span>
                <span>üèá ${meeting.race_count} races</span>
                <span>üìç ${meeting.track_code}</span>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #4a5568;">
                    Track Condition:
                </label>
                <select class="track-condition-select" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 100%; margin-bottom: 10px;">
                    <option value="firm">Firm</option>
                    <option value="good" selected>Good</option>
                    <option value="soft">Soft</option>
                    <option value="heavy">Heavy</option>
                    <option value="synthetic">Synthetic</option>
                </select>
            </div>
            <button onclick="importMeetingWithCondition(this); event.stopPropagation();" 
                    class="btn btn-primary" 
                    style="width: 100%; padding: 12px; font-size: 14px; font-weight: 600;">
                üì• Import Meeting
            </button>
        </div>
    `;
}
async function importMeeting(meetingId, cardElement) {
    cardElement.classList.add('importing');
    cardElement.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div>
            <p style="color: #6c757d; margin: 0;">Importing meeting...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/meetings/${meetingId}/import`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert('Import failed: ' + (data.error || 'Unknown error'));
            location.reload();
            return;
        }
        
        // Redirect to meeting view
        window.location.href = data.redirect_url;
        
    } catch (error) {
        console.error('Import error:', error);
        alert('Import failed: ' + error.message);
        location.reload();
    }
}

function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-container').style.display = 'block';
}
</script>

{% endblock %}
