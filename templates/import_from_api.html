{% extends "base.html" %}

{% block title %}Import from PuntingForm{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Page Header -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        <h1 style="font-size: 36px; font-weight: 700; margin-bottom: 10px;">
            üåê Import Meetings from PuntingForm
        </h1>
        <p style="font-size: 16px; opacity: 0.9; margin: 0;">
            Select a date to view and import available race meetings
        </p>
    </div>

    <!-- Date Selection Card -->
    <div style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #2d3748;">
            Select Meeting Date
        </h3>
        
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <input type="date" 
                   id="meeting-date" 
                   class="form-control" 
                   style="max-width: 200px; font-size: 16px; padding: 10px;"
                   value="{{ today }}">
            
            <button onclick="loadMeetings()" 
                    class="btn btn-primary" 
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 10px 30px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                üìÖ Get Meetings
            </button>
        </div>
        
        <p style="color: #718096; font-size: 14px; margin-top: 15px; margin-bottom: 0;">
            üí° Select a date to view all available meetings for that day
        </p>
    </div>

    <!-- Available Meetings Section -->
    <div id="meetings-container">
        <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">üèá</div>
            <h3 style="color: #718096; font-size: 18px; font-weight: 500;">
                Click "Get Meetings" to view available race meetings
            </h3>
        </div>
    </div>
</div>

<script>
// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('meeting-date').value = today;
});

async function loadMeetings() {
    const dateInput = document.getElementById('meeting-date').value;
    const container = document.getElementById('meetings-container');
    
    // Show loading state
    container.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p style="margin-top: 15px; color: #718096;">Loading meetings...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/meetings/date/${dateInput}`);
        const data = await response.json();
        
        if (!data.success || !data.meetings || data.meetings.length === 0) {
            container.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                    <h3 style="color: #718096; font-size: 18px; font-weight: 500;">
                        No meetings available for this date
                    </h3>
                </div>
            `;
            return;
        }
        
        // Group meetings by state
        const groupedMeetings = {};
        data.meetings.forEach(meeting => {
            if (!groupedMeetings[meeting.state]) {
                groupedMeetings[meeting.state] = [];
            }
            groupedMeetings[meeting.state].push(meeting);
        });
        
        // Render grouped meetings
        let html = '<div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
        html += '<h3 style="font-size: 22px; font-weight: 600; margin-bottom: 25px; color: #2d3748;">Available Meetings</h3>';
        html += '<p style="color: #718096; font-size: 14px; margin-bottom: 25px;">Click any meeting to import and analyze</p>';
        
        const stateColors = {
            'NSW': '#0066cc',
            'VIC': '#009933',
            'QLD': '#cc0000',
            'SA': '#ff6600',
            'WA': '#ffcc00',
            'TAS': '#6600cc',
            'NT': '#cc6600',
            'ACT': '#0099cc'
        };
        
        for (const [state, meetings] of Object.entries(groupedMeetings)) {
            const color = stateColors[state] || '#667eea';
            
            html += `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: ${color}; font-size: 18px; font-weight: 700; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 3px solid ${color};">
                        ${state}
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
            `;
            
            meetings.forEach(meeting => {
                const resultBadge = meeting.resulted ? 
                    '<span style="background: #48bb78; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">‚úì Results Available</span>' : 
                    '<span style="background: #cbd5e0; color: #4a5568; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Upcoming</span>';
                
                html += `
                    <div onclick="importMeeting('${meeting.meeting_id}')" 
                         style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); 
                                border: 2px solid #e2e8f0; 
                                border-radius: 12px; 
                                padding: 20px; 
                                cursor: pointer; 
                                transition: all 0.3s ease;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.05);"
                         onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)'; this.style.borderColor='${color}';"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'; this.style.borderColor='#e2e8f0';">
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h5 style="font-size: 18px; font-weight: 700; color: #2d3748; margin: 0;">
                                ${meeting.track_name}
                            </h5>
                            <span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;">
                                ${state}
                            </span>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 12px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 6px; color: #4a5568; font-size: 14px;">
                                <span>üìÖ</span>
                                <span>${meeting.date}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; color: #4a5568; font-size: 14px;">
                                <span>üèá</span>
                                <span>${meeting.race_count} races</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; color: #4a5568; font-size: 14px;">
                                <span>üìç</span>
                                <span>${meeting.track_code}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px;">
                            ${resultBadge}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading meetings:', error);
        container.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <h3 style="color: #e53e3e; font-size: 18px; font-weight: 500;">
                    Error loading meetings
                </h3>
                <p style="color: #718096; margin-top: 10px;">Please try again</p>
            </div>
        `;
    }
}

async function importMeeting(meetingId) {
    const selectedDate = document.getElementById('meeting-date').value;
    
    if (!confirm('Import this meeting and run the Partington Probability Engine analysis?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('date', selectedDate);
    
    try {
        const response = await fetch(`/api/meetings/${meetingId}/import`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success && data.redirect_url) {
            window.location.href = data.redirect_url;
        } else {
            alert('Error importing meeting: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Import error:', error);
        alert('Failed to import meeting. Please try again.');
    }
}
</script>
{% endblock %}
